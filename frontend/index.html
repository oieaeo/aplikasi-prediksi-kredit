<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Prediksi Risiko Kredit</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }
        .main-content {
            display: none;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
        }
        .nav-link.active {
            font-weight: 600;
            color: #0d6efd !important;
        }
        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
        }
        .kpi-card .metric-value {
            font-size: 1.75rem;
        }
        .kpi-card .card-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
        }
        .kpi-card .change-indicator {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .bg-success-light { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
        .bg-info-light { background-color: rgba(13, 202, 240, 0.1); color: #0dcaf0; }
        .bg-warning-light { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .bg-danger-light { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }

        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-label {
            font-weight: 500;
        }
        .section-title {
            font-weight: 600;
            color: #495057;
        }
        .tree-container img {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

    <!-- =================================================================
    LOGIN PAGE
    ================================================================== -->
    <div id="login-page" class="container">
        <div class="col-md-6 col-lg-4">
            <div class="card p-4 text-center">
                <div class="card-body">
                    <i class="bi bi-bank2 fs-1 text-primary mb-3"></i>
                    <h3 class="card-title mb-3">Sistem Prediksi Kredit</h3>
                    <p class="text-muted mb-4">Silakan pilih peran Anda untuk masuk.</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="login('analis')">
                            <i class="bi bi-person-vcard me-2"></i> Masuk sebagai Analis
                        </button>
                        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#manajerLoginModal">
                            <i class="bi bi-person-workspace me-2"></i> Masuk sebagai Manajer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manajer Login Modal -->
    <div class="modal fade" id="manajerLoginModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Login Manajer</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="manajerLoginForm">
              <div class="mb-3"><label for="usernameManajer" class="form-label">Username</label><input type="text" class="form-control" id="usernameManajer" required></div>
              <div class="mb-3"><label for="passwordManajer" class="form-label">Password</label><input type="password" class="form-control" id="passwordManajer" required></div>
              <div id="loginError" class="alert alert-danger mt-3" style="display: none;">Username atau password salah.</div>
              <button type="submit" class="btn btn-primary w-100 mt-3">Login</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- =================================================================
    MAIN APPLICATION CONTENT (HIDDEN BY DEFAULT)
    ================================================================== -->
    <div id="main-content" class="main-content">
        <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-bank2"></i> PrediksiKredit</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul id="nav-links" class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                    <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i> Keluar</a></li></ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid p-4">
            <!-- ANALIS: Halaman Prediksi -->
            <div id="prediksi-page" class="page">
                 <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <!-- Navigasi Tab Baru -->
                        <ul class="nav nav-tabs" id="predictionTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-prediction" type="button" role="tab">Prediksi Tunggal</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch-prediction" type="button" role="tab">Prediksi Massal (Batch)</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="predictionTabContent">
                            <!-- Konten Tab Prediksi Tunggal -->
                            <div class="tab-pane fade show active" id="single-prediction" role="tabpanel">
                                <div class="card p-4 p-md-5 border-top-0 rounded-top-0">
                                    <div class="card-body">
                                        <h3 class="card-title text-center mb-1">Formulir Prediksi Risiko Kredit</h3>
                                        <p class="text-muted text-center mb-4">Masukkan data calon nasabah untuk memulai.</p>
                                        <form id="creditForm">
                                            <h5 class="mb-3 mt-4 border-bottom pb-2 section-title"><i class="bi bi-person-vcard me-2"></i>Informasi Pribadi & Finansial</h5>
                                            <div class="row g-3">
                                                <div class="col-md-12"><label for="nama_nasabah" class="form-label">Nama Nasabah</label><input type="text" id="nama_nasabah" class="form-control" required placeholder="Contoh: Budi Santoso"></div>
                                                <div class="col-md-4"><label for="age" class="form-label">Umur</label><input type="number" id="age" class="form-control" required placeholder="Contoh: 35"></div>
                                                <div class="col-md-4"><label for="gender" class="form-label">Jenis Kelamin</label><select id="gender" class="form-select"><option value="F">Wanita</option><option value="M">Pria</option></select></div>
                                                <div class="col-md-4"><label for="income" class="form-label">Pendapatan Tahunan ($)</label><input type="number" id="income" class="form-control" required placeholder="Contoh: 50000"></div>
                                            </div>
                                            <h5 class="mb-3 mt-4 border-bottom pb-2 section-title"><i class="bi bi-clock-history me-2"></i>Informasi Riwayat Kredit</h5>
                                            <div class="row g-3">
                                                <div class="col-md-4"><label for="employment_years" class="form-label">Lama Bekerja (Tahun)</label><input type="number" id="employment_years" class="form-control" required placeholder="Contoh: 5"></div>
                                                <div class="col-md-4"><label for="credit_score" class="form-label">Skor Kredit</label><input type="number" id="credit_score" class="form-control" required placeholder="Contoh: 750"></div>
                                                <div class="col-md-4"><label for="credit_history_length_years" class="form-label">Lama Riwayat Kredit (Tahun)</label><input type="number" id="credit_history_length_years" class="form-control" required placeholder="Contoh: 10"></div>
                                            </div>
                                            <h5 class="mb-3 mt-4 border-bottom pb-2 section-title"><i class="bi bi-car-front-fill me-2"></i>Informasi Kendaraan</h5>
                                            <div class="row g-3">
                                                <div class="col-md-6"><label for="vehicle_age" class="form-label">Umur Kendaraan (Tahun)</label><input type="number" id="vehicle_age" class="form-control" required placeholder="Contoh: 2"></div>
                                                <div class="col-md-6"><label for="vehicle_type" class="form-label">Tipe Kendaraan</label><select id="vehicle_type" class="form-select"><option>Motorbike</option><option>Sedan</option><option>SUV</option><option>Truck</option></select></div>
                                            </div>
                                            <h5 class="mb-3 mt-4 border-bottom pb-2 section-title"><i class="bi bi-cash-coin me-2"></i>Detail Pengajuan Pinjaman</h5>
                                            <div class="row g-3">
                                                <div class="col-md-6"><label for="loan_amount" class="form-label">Jumlah Pinjaman ($)</label><input type="number" id="loan_amount" class="form-control" required placeholder="Contoh: 25000"></div>
                                                <div class="col-md-6"><label for="loan_term_months" class="form-label">Jangka Waktu (Bulan)</label><input type="number" id="loan_term_months" class="form-control" required placeholder="Contoh: 36"></div>
                                                <div class="col-md-6"><label for="interest_rate" class="form-label">Suku Bunga (%)</label><input type="number" step="0.01" id="interest_rate" class="form-control" required placeholder="Contoh: 0.05"></div>
                                                <div class="col-md-6"><label for="down_payment" class="form-label">Uang Muka / DP ($)</label><input type="number" id="down_payment" class="form-control" required placeholder="Contoh: 5000"></div>
                                                <div class="col-md-6"><label for="purpose" class="form-label">Tujuan Pinjaman</label><select id="purpose" class="form-select"><option>Refinance</option><option>Purchase</option></select></div>
                                                <div class="col-md-6"><label for="existing_loans_count" class="form-label">Jumlah Pinjaman Aktif Lainnya</label><input type="number" id="existing_loans_count" class="form-control" required placeholder="Contoh: 1"></div>
                                            </div>
                                            <div class="col-12 text-center mt-5 pt-4 border-top">
                                                 <button type="submit" id="predictBtn" class="btn btn-primary btn-lg px-5">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                                                    <i class="bi bi-magic me-2"></i>
                                                    <span id="predictBtnText">Prediksi Risiko</span>
                                                </button>
                                            </div>
                                        </form>
                                        <div id="hasilPrediksi" class="mt-4"></div>
                                        <div id="simulasiContainer" class="mt-4" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Konten Tab Prediksi Massal -->
                            <div class="tab-pane fade" id="batch-prediction" role="tabpanel">
                                <div class="card p-4 p-md-5 border-top-0 rounded-top-0">
                                    <div class="card-body">
                                        <h3 class="card-title text-center mb-1">Prediksi Massal (Batch)</h3>
                                        <p class="text-muted text-center mb-4">Unggah file .csv atau .xlsx untuk memprediksi banyak nasabah sekaligus.</p>
                                        <div class="mb-3">
                                            <label for="batchFile" class="form-label">Pilih File</label>
                                            <input class="form-control" type="file" id="batchFile" accept=".csv, .xlsx">
                                        </div>
                                        <div class="text-center mt-4">
                                            <button class="btn btn-primary btn-lg" id="batchPredictBtn">
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                                                <i class="bi bi-upload me-2"></i>
                                                <span id="batchPredictBtnText">Proses File</span>
                                            </button>
                                        </div>
                                        <div id="batchResultContainer" class="mt-4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALIS: Halaman Riwayat -->
            <div id="riwayat-page" class="page">
                <h2 class="mb-4">Riwayat Prediksi</h2>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID Nasabah</th>
                                        <th>Nama Nasabah</th>
                                        <th>Tanggal</th>
                                        <th>Hasil Prediksi</th>
                                    </tr>
                                </thead>
                                <tbody id="riwayat-table-body">
                                    <!-- Data riwayat akan diisi oleh JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANAJER: Halaman Dashboard (Tampilan Baru) -->
            <div id="dashboard-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Dashboard Manajer</h2>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-calendar-range me-2"></i>
                            <span id="filter-text">Bulan Ini</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdownButton">
                            <li><a class="dropdown-item" href="#" onclick="changeFilter('Bulan Ini')">Bulan Ini</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeFilter('3 Bulan')">3 Bulan</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeFilter('Tahun Ini')">Tahun Ini</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Baris KPI (Key Performance Indicators) -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card kpi-card h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-circle bg-info-light me-3"><i class="bi bi-file-earmark-text"></i></div>
                                <div>
                                    <div class="card-title text-uppercase">Total Prediksi</div>
                                    <div class="metric-value text-info" id="db-total-prediksi">0</div>
                                    <div class="change-indicator text-muted">Sesi ini</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card kpi-card h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-circle bg-success-light me-3"><i class="bi bi-check2-circle"></i></div>
                                <div>
                                    <div class="card-title text-uppercase">Akurasi Model</div>
                                    <div class="metric-value text-success">92.1%</div>
                                    <div class="change-indicator text-muted">Berdasarkan pelatihan</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card kpi-card h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-circle bg-danger-light me-3"><i class="bi bi-exclamation-triangle"></i></div>
                                <div>
                                    <div class="card-title text-uppercase">Risiko Tinggi Teridentifikasi</div>
                                    <div class="metric-value text-danger" id="db-risiko-tinggi">0</div>
                                    <div class="change-indicator text-muted">Sesi ini</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card kpi-card h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-circle bg-warning-light me-3"><i class="bi bi-shield-check"></i></div>
                                <div>
                                    <div class="card-title text-uppercase">Potensi Kerugian Dihindari</div>
                                    <div class="metric-value text-warning" id="db-kerugian-dihindari">$0</div>
                                    <div class="change-indicator text-muted">Estimasi sesi ini</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Baris Grafik -->
                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Tren Produktivitas Tim</h5>
                                <p class="card-subtitle text-muted mb-3">Jumlah prediksi yang diproses</p>
                                <div class="mt-auto" style="position: relative; height: 300px;">
                                    <canvas id="produktivitasChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Komposisi Risiko</h5>
                                <p class="card-subtitle text-muted mb-3">Distribusi hasil prediksi</p>
                                <div class="m-auto" style="position: relative; height:250px; width:250px;">
                                    <canvas id="komposisiRisikoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="row g-4 mt-1">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Tren Akurasi Model (Historis)</h5>
                                <p class="card-subtitle text-muted mb-3">Perkembangan akurasi dari waktu ke waktu</p>
                                <div style="position: relative; height: 250px;">
                                    <canvas id="akurasiChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANAJER: Halaman Umpan Balik (Tampilan Baru) -->
            <div id="umpan-balik-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Manajemen Umpan Balik Model</h2>
                </div>
                <div class="card">
                    <div class="card-header bg-white border-0 pt-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="feedbackFilter" id="filterSemua" autocomplete="off" checked onchange="filterFeedbackTable('semua')">
                            <label class="btn btn-outline-secondary" for="filterSemua">Tampilkan Semua</label>
                            
                            <input type="radio" class="btn-check" name="feedbackFilter" id="filterSalah" autocomplete="off" onchange="filterFeedbackTable('salah')">
                            <label class="btn btn-outline-secondary" for="filterSalah">Hanya Prediksi Salah</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID Nasabah</th>
                                        <th>Nama Nasabah</th>
                                        <th>Prediksi Awal</th>
                                        <th>Status Aktual</th>
                                        <th>Akurasi</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="umpan-balik-table-body">
                                    <!-- Data umpan balik akan diisi oleh JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANAJER: Halaman Pohon Tree (Halaman Baru) -->
            <div id="pohon-tree-page" class="page">
                <h2 class="mb-4">Visualisasi Pohon Keputusan</h2>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Diagram Alur Keputusan Model</h5>
                        <p class="card-text text-muted">
                            Ini adalah representasi visual dari bagaimana model mengambil keputusan. Dimulai dari node paling atas, model akan memeriksa sebuah kondisi (misalnya, "Apakah Skor Kredit <= 600?"). Jika 'Ya' (True), ia akan ke cabang kiri. Jika 'Tidak' (False), ke cabang kanan. Proses ini berlanjut hingga mencapai node daun yang memberikan prediksi akhir (Low, Medium, atau High).
                            <br><strong>Catatan:</strong> Gambar ini hanya menampilkan 4 level pertama dari pohon untuk kemudahan pembacaan.
                        </p>
                        <hr>
                        <div class="tree-container bg-light p-3 rounded">
                            <img src="assets/pohon_keputusan.png" alt="Visualisasi Pohon Keputusan" class="img-fluid">
                        </div>
                    </div>
                </div>
            </div>

            <!-- HALAMAN BARU: Panduan Pengisian -->
            <div id="panduan-page" class="page">
                <h2 class="mb-4">Panduan Pengisian Formulir</h2>
                <div class="accordion" id="panduanAccordion">
                    <!-- Item 1 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <strong>Informasi Pribadi & Finansial</strong>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#panduanAccordion">
                            <div class="accordion-body">
                                <p><strong>Nama Nasabah:</strong> Isi dengan nama lengkap calon nasabah.</p>
                                <p><strong>Umur:</strong> Usia nasabah dalam tahun.</p>
                                <p><strong>Jenis Kelamin:</strong> Pilih jenis kelamin nasabah.</p>
                                <p><strong>Pendapatan Tahunan ($):</strong> Total pendapatan nasabah dalam satu tahun (dalam Dolar).</p>
                            </div>
                        </div>
                    </div>
                    <!-- Item 2 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <strong>Informasi Riwayat Kredit</strong>
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#panduanAccordion">
                            <div class="accordion-body">
                                <p><strong>Lama Bekerja (Tahun):</strong> Total durasi nasabah telah bekerja di pekerjaannya saat ini.</p>
                                <p><strong>Skor Kredit:</strong> Angka yang merepresentasikan kelayakan kredit nasabah (biasanya 300-850). Semakin tinggi, semakin baik.</p>
                                <p><strong>Lama Riwayat Kredit (Tahun):</strong> Sejak kapan nasabah mulai memiliki riwayat kredit (misalnya, sejak pertama kali memiliki kartu kredit).</p>
                            </div>
                        </div>
                    </div>
                    <!-- Item 3 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <strong>Informasi Kendaraan</strong>
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#panduanAccordion">
                            <div class="accordion-body">
                                <p><strong>Umur Kendaraan (Tahun):</strong> Usia kendaraan yang akan dijadikan jaminan.</p>
                                <p><strong>Tipe Kendaraan:</strong> Pilih jenis kendaraan yang sesuai.</p>
                            </div>
                        </div>
                    </div>
                     <!-- Item 4 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                <strong>Detail Pengajuan Pinjaman</strong>
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#panduanAccordion">
                            <div class="accordion-body">
                                <p><strong>Jumlah Pinjaman ($):</strong> Total uang yang ingin dipinjam oleh nasabah.</p>
                                <p><strong>Jangka Waktu (Bulan):</strong> Durasi pinjaman dalam bulan (tenor).</p>
                                <p><strong>Suku Bunga (%):</strong> Bunga pinjaman dalam format desimal (misal: 5% ditulis 0.05).</p>
                                <p><strong>Uang Muka / DP ($):</strong> Jumlah uang muka yang dibayarkan nasabah.</p>
                                <p><strong>Tujuan Pinjaman:</strong> Pilih tujuan penggunaan dana pinjaman.</p>
                                <p><strong>Jumlah Pinjaman Aktif Lainnya:</strong> Jumlah pinjaman lain yang masih aktif dimiliki nasabah saat ini.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // === GLOBAL STATE & DATA ===
        let currentUserRole = null;
        let riwayatPrediksi = [];
        let charts = {};
        let currentFormData = {}; // Untuk menyimpan data form saat ini untuk simulasi

        // === FUNGSI PENYIMPANAN LOKAL ===
        function saveHistoryToLocalStorage() {
            localStorage.setItem('creditPredictionHistory', JSON.stringify(riwayatPrediksi));
        }

        function loadHistoryFromLocalStorage() {
            const savedHistory = localStorage.getItem('creditPredictionHistory');
            if (savedHistory) {
                riwayatPrediksi = JSON.parse(savedHistory);
                populateRiwayatTable();
                populateUmpanBalikTable();
                updateDashboardMetrics();
            }
        }

        // === FUNGSI UTAMA: MENGHUBUNGKAN FRONTEND & BACKEND ===
        document.getElementById('creditForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const namaNasabah = document.getElementById('nama_nasabah').value;
            const formData = getFormData();
            runPrediction(namaNasabah, formData, true); // true menandakan ini prediksi baru
        });

        async function runPrediction(nama, formData, isNewPrediction) {
            const predictBtn = document.getElementById('predictBtn');
            const btnSpinner = predictBtn.querySelector('.spinner-border');
            const btnIcon = predictBtn.querySelector('.bi-magic');
            const btnText = document.getElementById('predictBtnText');
            const hasilContainer = document.getElementById('hasilPrediksi');

            predictBtn.disabled = true;
            btnSpinner.style.display = 'inline-block';
            btnIcon.style.display = 'none';
            btnText.textContent = 'Memproses...';
            if (isNewPrediction) {
                hasilContainer.innerHTML = '';
                document.getElementById('simulasiContainer').style.display = 'none';
            }

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                displayPredictionResult(result);
                
                if (isNewPrediction) {
                    addPredictionToHistory(nama, formData, result);
                    currentFormData = formData; // Simpan data untuk simulasi
                    showSimulasiForm();
                }

            } catch (error) {
                displayConnectionError(error);
            } finally {
                resetPredictButton();
            }
        }

        function getFormData() {
            return {
                age: parseInt(document.getElementById('age').value) || 0,
                gender: document.getElementById('gender').value,
                income: parseFloat(document.getElementById('income').value) || 0,
                employment_years: parseInt(document.getElementById('employment_years').value) || 0,
                credit_score: parseInt(document.getElementById('credit_score').value) || 0,
                existing_loans_count: parseInt(document.getElementById('existing_loans_count').value) || 0,
                loan_amount: parseFloat(document.getElementById('loan_amount').value) || 0,
                loan_term_months: parseInt(document.getElementById('loan_term_months').value) || 0,
                vehicle_age: parseInt(document.getElementById('vehicle_age').value) || 0,
                vehicle_type: document.getElementById('vehicle_type').value,
                purpose: document.getElementById('purpose').value,
                credit_history_length_years: parseInt(document.getElementById('credit_history_length_years').value) || 0,
                interest_rate: parseFloat(document.getElementById('interest_rate').value) || 0,
                down_payment: parseFloat(document.getElementById('down_payment').value) || 0
            };
        }

        function displayPredictionResult(result) {
            const hasilContainer = document.getElementById('hasilPrediksi');
            let alertClass = 'alert-success', iconClass = 'bi-check-circle-fill';
            let riskText = result.risiko.charAt(0).toUpperCase() + result.risiko.slice(1);

            if (result.risiko === 'High') {
                alertClass = 'alert-danger'; iconClass = 'bi-exclamation-triangle-fill';
            } else if (result.risiko === 'Medium') {
                alertClass = 'alert-warning'; iconClass = 'bi-exclamation-circle-fill';
            }

            // Menampilkan Faktor Penentu
            let faktorHtml = result.faktor_penentu.map(faktor => `<span class="badge bg-secondary me-1">${faktor.replace(/_/g, ' ')}</span>`).join('');

            hasilContainer.innerHTML = `
                <div class="alert ${alertClass} mt-4" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi ${iconClass} me-3 fs-4"></i>
                        <div><h5 class="alert-heading">Hasil Prediksi: Risiko ${riskText}</h5><p class="mb-0">${result.alasan}</p></div>
                    </div>
                    <hr>
                    <p class="mb-1 fw-bold">Faktor Penentu Utama:</p>
                    <div>${faktorHtml}</div>
                </div>`;
        }
        
        function displayConnectionError(error) {
            document.getElementById('hasilPrediksi').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center mt-4" role="alert">
                    <i class="bi bi-x-octagon-fill me-3 fs-4"></i>
                    <div><h5 class="alert-heading">Gagal Terhubung ke Server</h5><p>Pastikan backend server sudah berjalan. Error: ${error.message}</p></div>
                </div>`;
        }

        function resetPredictButton() {
            const predictBtn = document.getElementById('predictBtn');
            predictBtn.disabled = false;
            predictBtn.querySelector('.spinner-border').style.display = 'none';
            predictBtn.querySelector('.bi-magic').style.display = 'inline-block';
            document.getElementById('predictBtnText').textContent = 'Prediksi Risiko';
        }

        function addPredictionToHistory(nama, formData, result) {
            const newEntry = {
                id: `NSB-${String(riwayatPrediksi.length + 1).padStart(4, '0')}`,
                nama: nama,
                tanggal: new Date().toLocaleDateString('id-ID'),
                income: formData.income,
                credit_score: formData.credit_score,
                loan_amount: formData.loan_amount,
                hasil: result.risiko,
                statusAktual: null
            };
            riwayatPrediksi.unshift(newEntry);
            saveHistoryToLocalStorage();
            populateRiwayatTable();
            populateUmpanBalikTable();
            updateDashboardMetrics();
        }
        
        // --- FITUR BARU: SIMULASI "WHAT-IF" ---
        function showSimulasiForm() {
            const simulasiContainer = document.getElementById('simulasiContainer');
            simulasiContainer.style.display = 'block';
            simulasiContainer.innerHTML = `
                <div class="card bg-light mt-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-joystick me-2"></i>Mode Simulasi "What-If"</h5>
                        <p class="card-text text-muted">Ubah beberapa nilai di bawah ini untuk melihat bagaimana risiko dapat berubah.</p>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="sim_income" class="form-label">Pendapatan ($)</label>
                                <input type="number" id="sim_income" class="form-control" value="${currentFormData.income}">
                            </div>
                            <div class="col-md-4">
                                <label for="sim_down_payment" class="form-label">Uang Muka / DP ($)</label>
                                <input type="number" id="sim_down_payment" class="form-control" value="${currentFormData.down_payment}">
                            </div>
                            <div class="col-md-4">
                                <label for="sim_loan_term_months" class="form-label">Jangka Waktu (Bulan)</label>
                                <input type="number" id="sim_loan_term_months" class="form-control" value="${currentFormData.loan_term_months}">
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-warning" onclick="runSimulation()">
                                <i class="bi bi-arrow-repeat me-2"></i>Jalankan Ulang Simulasi
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        function runSimulation() {
            let simulatedData = { ...currentFormData }; // Salin data asli
            // Perbarui dengan nilai dari form simulasi
            simulatedData.income = parseFloat(document.getElementById('sim_income').value) || 0;
            simulatedData.down_payment = parseFloat(document.getElementById('sim_down_payment').value) || 0;
            simulatedData.loan_term_months = parseInt(document.getElementById('sim_loan_term_months').value) || 0;
            
            // Jalankan prediksi lagi, tapi tandai sebagai bukan prediksi baru (tidak disimpan ke riwayat)
            runPrediction(null, simulatedData, false);
        }

        // --- FITUR BARU: PREDIKSI MASSAL ---
        document.getElementById('batchPredictBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('batchFile');
            if (fileInput.files.length === 0) {
                alert('Silakan pilih file terlebih dahulu.');
                return;
            }

            const btn = this;
            const btnSpinner = btn.querySelector('.spinner-border');
            const btnIcon = btn.querySelector('.bi-upload');
            const btnText = document.getElementById('batchPredictBtnText');
            const resultContainer = document.getElementById('batchResultContainer');

            btn.disabled = true;
            btnSpinner.style.display = 'inline-block';
            btnIcon.style.display = 'none';
            btnText.textContent = 'Memproses...';
            resultContainer.innerHTML = '';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/batch-predict', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayBatchResults(data.results);

            } catch (error) {
                resultContainer.innerHTML = `<div class="alert alert-danger mt-4">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btnSpinner.style.display = 'none';
                btnIcon.style.display = 'inline-block';
                btnText.textContent = 'Proses File';
            }
        });

        function displayBatchResults(results) {
            const resultContainer = document.getElementById('batchResultContainer');
            let tableHtml = `<div class="table-responsive mt-4"><table class="table table-bordered table-striped">
                <thead class="table-light"><tr><th>ID Pelanggan</th><th>Pendapatan</th><th>Skor Kredit</th><th>Prediksi Risiko</th></tr></thead><tbody>`;
            
            results.forEach(item => {
                let badgeClass = 'bg-success-light text-success';
                if (item.predicted_risk === 'High') badgeClass = 'bg-danger-light text-danger';
                if (item.predicted_risk === 'Medium') badgeClass = 'bg-warning-light text-warning';

                tableHtml += `<tr>
                    <td>${item.customer_id || '-'}</td>
                    <td>$${item.income.toLocaleString()}</td>
                    <td>${item.credit_score}</td>
                    <td><span class="badge ${badgeClass} p-2">${item.predicted_risk}</span></td>
                </tr>`;
            });

            tableHtml += '</tbody></table></div>';
            resultContainer.innerHTML = tableHtml;
        }


        // --- FUNGSI TAMPILAN LAINNYA ---
        function populateRiwayatTable() {
            const tableBody = document.getElementById('riwayat-table-body');
            tableBody.innerHTML = '';
            riwayatPrediksi.forEach(item => {
                let badgeClass = 'bg-success-light text-success';
                if (item.hasil === 'High') badgeClass = 'bg-danger-light text-danger';
                if (item.hasil === 'Medium') badgeClass = 'bg-warning-light text-warning';
                
                const row = `<tr>
                    <td>${item.id}</td>
                    <td>${item.nama}</td>
                    <td>${item.tanggal}</td>
                    <td><span class="badge ${badgeClass} p-2">${item.hasil}</span></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function populateUmpanBalikTable(filter = 'semua') {
            const tableBody = document.getElementById('umpan-balik-table-body');
            tableBody.innerHTML = '';
            let filteredData = riwayatPrediksi;

            if (filter === 'salah') {
                filteredData = riwayatPrediksi.filter(item => item.statusAktual && item.statusAktual.toLowerCase() !== item.hasil.toLowerCase());
            }

            filteredData.forEach(item => {
                let badgeClass = 'bg-secondary-light text-secondary';
                let akurasiText = '-';
                let akurasiIcon = '';

                if(item.statusAktual) {
                    const isCorrect = item.statusAktual.toLowerCase() === item.hasil.toLowerCase();
                    badgeClass = isCorrect ? 'bg-success-light text-success' : 'bg-danger-light text-danger';
                    akurasiText = isCorrect ? 'Benar' : 'Salah';
                    akurasiIcon = isCorrect ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>';
                }

                const row = `<tr data-id="${item.id}">
                    <td>${item.id}</td>
                    <td>${item.nama}</td>
                    <td><span class="badge ${badgeClass} p-2">${item.hasil}</span></td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateStatusAktual('${item.id}', this.value)">
                            <option value="" ${!item.statusAktual ? 'selected' : ''}>Pilih Status...</option>
                            <option value="Low" ${item.statusAktual === 'Low' ? 'selected' : ''}>Lancar (Low)</option>
                            <option value="Medium" ${item.statusAktual === 'Medium' ? 'selected' : ''}>Sedang (Medium)</option>
                            <option value="High" ${item.statusAktual === 'High' ? 'selected' : ''}>Macet (High)</option>
                        </select>
                    </td>
                    <td class="text-center">${akurasiIcon} ${akurasiText}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="saveFeedback('${item.id}')">Simpan</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function updateStatusAktual(id, status) {
            const item = riwayatPrediksi.find(p => p.id === id);
            if (item) {
                item.statusAktual = status;
                saveHistoryToLocalStorage();
                filterFeedbackTable();
            }
        }
        
        function saveFeedback(id) {
            alert(`Umpan balik untuk ${id} telah disimpan.`);
        }

        function filterFeedbackTable(filterType) {
            const currentFilter = filterType || document.querySelector('input[name="feedbackFilter"]:checked').id.replace('filter', '').toLowerCase();
            populateUmpanBalikTable(currentFilter);
        }

        function updateDashboardMetrics() {
            document.getElementById('db-total-prediksi').textContent = riwayatPrediksi.length;
            
            const highRiskPredictions = riwayatPrediksi.filter(p => p.hasil === 'High');
            document.getElementById('db-risiko-tinggi').textContent = highRiskPredictions.length;

            const averageLoanAmount = 25000;
            const potentialLossAvoided = highRiskPredictions.reduce((sum, item) => sum + (item.loan_amount || averageLoanAmount), 0);
            document.getElementById('db-kerugian-dihindari').textContent = `$${(potentialLossAvoided / 1000).toFixed(0)}K`;

            if (charts.komposisiRisikoChart) {
                const lowCount = riwayatPrediksi.filter(p => p.hasil === 'Low').length;
                const mediumCount = riwayatPrediksi.filter(p => p.hasil === 'Medium').length;
                charts.komposisiRisikoChart.data.datasets[0].data = [lowCount, mediumCount, highRiskPredictions.length];
                charts.komposisiRisikoChart.update();
            }

            if (charts.produktivitasChart) {
                const last6counts = Array(6).fill(0);
                riwayatPrediksi.slice(0, 6).forEach((_, index) => {
                    last6counts[5 - index] = (Math.random() * 10 + 1);
                });
                charts.produktivitasChart.data.datasets[0].data = last6counts.map((_, i) => riwayatPrediksi.length > i ? riwayatPrediksi.length - i : 0);
                charts.produktivitasChart.update();
            }
        }

        // === NAVIGASI & LOGIN/LOGOUT ===
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelector(`#${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`a[onclick="navigateTo('${pageId}')"]`).classList.add('active');
            if (pageId === 'dashboard-page') initDashboardCharts();
        }

        function login(role) {
            currentUserRole = role;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            setupNavbar();
            if (role === 'analis') navigateTo('prediksi-page');
            else if (role === 'manajer') navigateTo('dashboard-page');
        }

        function logout() {
            currentUserRole = null;
            localStorage.removeItem('creditPredictionHistory'); 
            riwayatPrediksi = [];
            updateDashboardMetrics();
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('manajerLoginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        function setupNavbar() {
            const navLinksContainer = document.getElementById('nav-links');
            let links = '';
            if (currentUserRole === 'analis') {
                links = `<li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('prediksi-page')"><i class="bi bi-magic me-1"></i> Prediksi</a></li>
                         <li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('riwayat-page')"><i class="bi bi-clock-history me-1"></i> Riwayat</a></li>
                         <li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('panduan-page')"><i class="bi bi-question-circle-fill me-1"></i> Panduan</a></li>`;
            } else if (currentUserRole === 'manajer') {
                links = `<li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('dashboard-page')"><i class="bi bi-bar-chart-line-fill me-1"></i> Dashboard</a></li>
                         <li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('umpan-balik-page')"><i class="bi bi-card-checklist me-1"></i> Umpan Balik</a></li>
                         <li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('pohon-tree-page')"><i class="bi bi-diagram-3-fill me-1"></i> Pohon Tree</a></li>
                         <li class="nav-item"><a class="nav-link" href="#" onclick="navigateTo('panduan-page')"><i class="bi bi-question-circle-fill me-1"></i> Panduan</a></li>`;
            }
            navLinksContainer.innerHTML = links;
        }

        document.getElementById('manajerLoginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('usernameManajer').value;
            const password = document.getElementById('passwordManajer').value;
            if (username === 'engkong' && password === 'admin') {
                const modal = bootstrap.Modal.getInstance(document.getElementById('manajerLoginModal'));
                if(modal) modal.hide();
                login('manajer');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        // === LOGIC UNTUK DASHBOARD CHARTS ===
        function initDashboardCharts() {
            const chartIds = ['produktivitasChart', 'komposisiRisikoChart', 'akurasiChart'];
            chartIds.forEach(id => { if (charts[id]) charts[id].destroy(); });

            const defaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
            
            charts.produktivitasChart = new Chart(document.getElementById('produktivitasChart').getContext('2d'), { 
                type: 'bar', 
                data: { 
                    labels: ['Prediksi 1', 'Prediksi 2', 'Prediksi 3', 'Prediksi 4', 'Prediksi 5', 'Prediksi 6'], 
                    datasets: [{ 
                        label: 'Jumlah Pengajuan Diproses', 
                        data: [],
                        backgroundColor: 'rgba(13, 202, 240, 0.6)' 
                    }] 
                }, 
                options: defaultOptions 
            });
            
            charts.komposisiRisikoChart = new Chart(document.getElementById('komposisiRisikoChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Rendah', 'Sedang', 'Tinggi'],
                    datasets: [{
                        label: 'Komposisi Risiko',
                        data: [0, 0, 0],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                        hoverOffset: 4
                    }]
                },
                options: defaultOptions
            });

            charts.akurasiChart = new Chart(document.getElementById('akurasiChart').getContext('2d'), { 
                type: 'line', 
                data: { 
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'], 
                    datasets: [{ 
                        label: 'Akurasi (%)', 
                        data: [88, 89.5, 90, 91.2, 90.8, 92.1], 
                        borderColor: '#198754', 
                        backgroundColor: 'rgba(25, 135, 84, 0.1)', 
                        fill: true, 
                        tension: 0.3 
                    }] 
                }, 
                options: defaultOptions 
            });

            updateDashboardMetrics();
        }

        function changeFilter(text) {
            document.getElementById('filter-text').textContent = text;
        }

        // Panggil fungsi ini saat halaman pertama kali dimuat
        document.addEventListener('DOMContentLoaded', (event) => {
            loadHistoryFromLocalStorage();
        });
    </script>
</body>
</html>